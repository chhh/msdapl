<?xml version="1.0" encoding="UTF-8" ?> 
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
      "http://ibatis.apache.org/dtd/sql-map-2.dtd"> 
<sqlMap namespace="MsRun"> 

	<typeAlias alias="MsRun" type="org.yeastrc.ms.dto.MsRun"/>
	
	<resultMap class="MsRun" id="msRunResult" groupBy="id">
		<result property="id" column="runID" />
		<result property="msExperimentId" column="experimentID" />
		<result property="fileName" column="filename" />
		<result property="fileFormat" column="originalFileType" />
		<result property="sha1Sum" column="sha1Sum" />
		<result property="creationDate" column="creationTime" />
		<result property="conversionSW" column="extractor" />
		<result property="conversionSWVersion" column="extractorVersion" />
		<result property="dataType" column="dataType" />
		<result property="conversionSWOptions" column="extractorOptions" />
		<result property="instrumentVendor" column="instrumentVendor" />
		<result property="instrumentModel" column="instrumentType" />
		<result property="instrumentSN" column="instrumentSN" />
		<result property="acquisitionMethod" column="acquisitionMethod" />
		<result property="comment" column="comment" />
		<result property="enzymeList" resultMap="MsDigestionEnzyme.msEnzymeResult"/>
	</resultMap>
	
	<!--  
		<result property="enzymeList" resultMap="MsDigestionEnzyme.msEnzymeResult"/>
		-->
		
	<parameterMap class="MsRun" id="msRunParam">
		<parameter property="msExperimentId" jdbcType="INTEGER" />
		<parameter property="fileName" jdbcType="VARCHAR"/>
		<parameter property="sha1Sum" jdbcType="CHAR"/>
		<parameter property="creationDate" jdbcType="VARCHAR"/>
		<parameter property="conversionSW" jdbcType="VARCHAR"/>
		<parameter property="conversionSWVersion" jdbcType="VARCHAR"/>
		<parameter property="conversionSWOptions" jdbcType="VARCHAR"/>
		<parameter property="instrumentModel" jdbcType="VARCHAR"/>
		<parameter property="instrumentVendor" jdbcType="VARCHAR"/>
		<parameter property="instrumentSN" jdbcType="VARCHAR"/>
		<parameter property="dataType" jdbcType="VARCHAR"/>
		<parameter property="acquisitionMethod" jdbcType="VARCHAR" />
		<parameter property="fileFormat" jdbcType="VARCHAR"/>
		<parameter property="comment" jdbcType="VARCHAR"/>
	</parameterMap>
	
    
    <select id="selectRunsForExperiment" resultMap="msRunResult" parameterClass="Integer">
    	SELECT 
    	r.id AS runID, 
    	r.experimentID AS experimentID, 
    	r.filename AS filename, 
    	r.sha1Sum AS sha1Sum, 
    	r.creationTime AS creationTime, 
    	r.extractor AS extractor,
    	r.extractorVersion AS extractorVersion,
    	r.extractorOptions AS extractorOptions,
    	r.instrumentType AS instrumentType, 
    	r.instrumentVendor AS instrumentVendor,
    	r.instrumentSN AS instrumentSN, 
    	r.dataType AS dataType, 
    	r.acquisitionMethod AS acquisitionMethod,
    	r.originalFileType AS originalFileType,
    	r.comment AS comment,
    	e.id AS id, 
    	e.name AS name, 
    	e.sense AS sense, 
    	e.cut AS cut, 
    	e.nocut AS nocut, 
    	e.description AS description 
    	FROM msRun AS r 
    	LEFT JOIN msRunEnzyme ON(r.id = MsRunEnzyme.runID)
    	LEFT JOIN msDigestionEnzyme AS e ON(msRunEnzyme.enzymeID = e.id)
    	WHERE r.experimentID=#id#
    	ORDER BY runID;
    </select>
    
    <select id="selectRunIdsForExperiment" resultClass="Integer"> 
        SELECT id FROM msRun WHERE experimentID = #id#
    </select> 
    
    <select id="selectRunIdsForFileNameAndSha1Sum" resultClass="Integer" parameterClass="java.util.Map"> 
        SELECT id FROM msRun WHERE filename = #fileName# AND sha1Sum = #sha1Sum#
    </select> 
    
    <select id="select" resultMap="msRunResult" parameterClass="Integer"> 
        SELECT 
    	r.id AS runID, 
    	r.experimentID AS experimentID, 
    	r.filename AS filename, 
    	r.sha1Sum AS sha1Sum, 
    	r.creationTime AS creationTime, 
    	r.extractor AS extractor,
    	r.extractorVersion AS extractorVersion,
    	r.extractorOptions AS extractorOptions,
    	r.instrumentType AS instrumentType, 
    	r.instrumentVendor AS instrumentVendor,
    	r.instrumentSN AS instrumentSN, 
    	r.dataType AS dataType, 
    	r.acquisitionMethod AS acquisitionMethod,
    	r.originalFileType AS originalFileType,
    	r.comment AS comment,
    	e.id AS id, 
    	e.name AS name, 
    	e.sense AS sense, 
    	e.cut AS cut, 
    	e.nocut AS nocut, 
    	e.description AS description 
    	FROM msRun AS r 
    	LEFT JOIN msRunEnzyme ON(r.id = MsRunEnzyme.runID)
    	LEFT JOIN msDigestionEnzyme AS e ON(msRunEnzyme.enzymeID = e.id)
    	WHERE r.id=#id#
    	ORDER BY runID;
    </select> 
    
    <insert id="insert" parameterMap="msRunParam">
    	INSERT INTO MsRun (experimentID, 
    						filename, 
    						sha1Sum,
    						creationTime, 
    						extractor, 
    						extractorVersion, 
    						extractorOptions, 
    						instrumentType, 
    						instrumentVendor, 
    						instrumentSN,
    						dataType,
    						acquisitionMethod,
    						originalFileType, 
    						comment) 
    	VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?)
    	<selectKey resultClass="int" keyProperty="id">
      		select last_insert_id() as id
    	</selectKey>
    </insert>
    
    <delete id="deleteByExperimentId" parameterClass="Integer">
		DELETE FROM MsRun WHERE experimentID=#id#		    
    </delete>
    
</sqlMap>